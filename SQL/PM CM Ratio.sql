select
    ILOA.EQFNR AS "tag_id"
    ,ILOA.ABCKZ AS "abc"
    ,EQUI.EQART AS "eq_type"
    ,CRHD.ARBPL AS "eq_work_center"
    ,ILOA.TPLNR AS "floc"
    --,AFRU.ISMNW
    --,COUNT(CASE WHEN AUFK.AUART = '8F01' THEN 1 ELSE null END) OVER (PARTITION BY AFIH.AUFNR) AS "CM"
    --,COUNT(CASE WHEN AUFK.AUART = '8F02' THEN 1 ELSE null END) OVER (PARTITION BY AFIH.AUFNR) AS "PM"
    ,SUM(CASE WHEN AUFK.AUART = '8F01' THEN AFVV.ISMNW ELSE 0 END) AS "cm_work"
    ,SUM(CASE WHEN AUFK.AUART = '8F02' THEN AFVV.ISMNW ELSE 0 END) AS "pm_work"
    ,COUNT(CASE WHEN AUFK.AUART = '8F01' THEN 1 ELSE null END) AS "CM"
    ,COUNT(CASE WHEN AUFK.AUART = '8F02' THEN 1 ELSE null END) AS "PM"
    --,SUM(CASE AFRU.STOKZ WHEN 'X' THEN AFRU.ISMNW * -1 ELSE AFRU.ISMNW END) AS "CMH"
    --,SUM(AFVV.ISMNW) OVER (PARTITION BY AFVC.AUFPL, AFVV.APLZL) AS "actual_work"
    /*
    ,(
    SELECT
        SUM(AFVV.ISMNW)
        FROM AFVC
        JOIN AFVV ON AFVV.AUFPL = AFVC.AUFPL AND AFVV.APLZL = AFVC.APLZL
        WHERE AFVC.AUFPL = AFKO.AUFPL
    ) AS "actual_work"
    */
from AFIH
JOIN AUFK ON AUFK.AUFNR = AFIH.AUFNR
JOIN AFKO ON AFKO.AUFNR = AUFK.AUFNR
JOIN AFVC ON AFVC.AUFPL = AFKO.AUFPL
JOIN AFVV ON AFVV.AUFPL = AFVC.AUFPL AND AFVV.APLZL = AFVC.APLZL
--JOIN AFRU ON AFRU.RUECK = AFVC.RUECK
--JOIN AFVV ON AFVV.AUFPL = AFVC.AUFPL AND AFVV.APLZL = AFVC.APLZL
JOIN EQUI ON EQUI.EQUNR = AFIH.EQUNR
JOIN EQUZ ON EQUZ.EQUNR = EQUI.EQUNR AND EQUZ.MANDT = EQUI.MANDT AND EQUZ.DATBI = '99991231'
JOIN CRHD ON CRHD.OBJID = EQUZ.GEWRK
FULL OUTER JOIN ILOA ON ILOA.ILOAN = EQUZ.ILOAN

where
AUFK.AUART IN ('8F01', '8F02')
and AUFK.ERDAT between '20180101' and '20181231'
and AFIH.EQUNR IN (
'000000002000010170',
'000000002000010408',
'000000002000011710',
'000000002000015395',
'000000002000000393',
'000000002000000367',
'000000002000000371',
'000000002000000372',
'000000002000000409',
'000000002000036885',
'000000002000017460',
'000000002000015404',
'000000002000017464',
'000000002000017176',
'000000002000015405',
'000000002000011707',
'000000002000011714',
'000000002000021003',
'000000002000011712',
'000000002000011711',
'000000002000011700',
'000000002000011717',
'000000002000017467',
'000000002000011702',
'000000002000036884',
'000000002000017177',
'000000002000000407',
'000000002000011750',
'000000002000011751',
'000000002000011752',
'000000002000011753',
'000000002000010343',
'000000002000010344',
'000000002000010345',
'000000002000010346',
'000000002000010347',
'000000002000010348',
'000000002000010349',
'000000002000010350',
'000000002000010351',
'000000002000010352',
'000000002000010353',
'000000002000010354',
'000000002000000299',
'000000002000000300',
'000000002000000301',
'000000002000000302',
'000000002000000303',
'000000002000000304',
'000000002000000305',
'000000002000000306',
'000000002000000307',
'000000002000000308',
'000000002000000309',
'000000002000000310',
'000000002000000348',
'000000002000000366'
)
AND 
(
    NOT EXISTS (
        SELECT TJ02T.TXT04
        FROM JEST
        JOIN TJ02T ON JEST.STAT = TJ02T.ISTAT
        WHERE JEST.OBJNR = EQUI.OBJNR AND JEST.INACT != 'X' AND TJ02T.SPRAS = 'E'
        AND TJ02T.TXT04 IN ('DLFL', 'INAC')
    )
)

AND 
(
    EXISTS (
        SELECT TJ02T.TXT04
        FROM JEST
        JOIN TJ02T ON JEST.STAT = TJ02T.ISTAT
        WHERE JEST.OBJNR = EQUI.OBJNR AND JEST.INACT != 'X' AND TJ02T.SPRAS = 'E'
        AND TJ02T.TXT04 IN ('INST', 'AVLB', 'ASEQ')
    )
) 

GROUP BY ILOA.EQFNR, ILOA.ABCKZ, EQUI.EQART, CRHD.ARBPL, ILOA.TPLNR

--order by ILOA.EQFNR
;